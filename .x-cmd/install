# shellcheck shell=bash disable=SC1091,SC2034,SC2154 #xsh

# Section: Arg
WORK_DIR="$(x wsroot)"
xrc ui

# Section: Function
install() {
    param:dsl       '
type:
    Type = all update plugin clean
options:
    --p    "select target install command"        <>:Type
'
    param:run
    install_"${p}"
}

use_npm_verison() {
	[ -z "$(command -v nvm)" ] \
		&& printf "%s\n" "Not command nvm" \
		&& xrc install  \
		&& install nvm \
		&& return 1
	nvm use
}

install_none() {
	[ ! -d "$WORK_DIR/node_modules" ] && \
		 use_npm_verison && yarn install && x build plugin
	return 0
}

install_update() {
	local ___X_CMD_UI_FORM_EXIT_STRATEGY="execute|exit"
    ___x_cmd_ui_form "Are you sure you want to delete $(___x_cmd_ui bold "node_modules")" tf 1 = "yes" "no"
	if [ "$tf" != "yes" ];then
		rm -rf "$WORK_DIR/node_modules"
		use_npm_verison && yarn install && x build plugin
	else
		use_npm_verison && yarn install && x build plugin
	fi
}

install_plugin() {
	shift; use_npm_verison && yarn add -D -W "$@"
}

install_all() {
	rm -rf "$WORK_DIR/node_modules" "$WORK_DIR/yarn.lock"
	use_npm_verison && x build clean && yarn install && x build plugin
}

case "${1}" in
    none)   		install_none     			;;
    update)   	install_update    		;;
    plugin)  		install_plugin "$@" 	;;
    all)    		install_all       		;;
    *)      		install           		;;
esac

# Section: Main

